<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Size Diff Demo</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <style>
        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
            min-height: 100vh;
        }

        body {
            background: #f8f9fa;
            color: #333;
            font-family: Arial, sans-serif;
        }

        h1,
        h3 {
            color: #2c3e50;
        }

        .canvas-container {
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 20px 0;
            overflow: hidden;
            background: white;
        }

        #interactive-canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .control-panel {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .character-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .character-item {
            background: white;
            margin: 5px 0;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .character-item:hover {
            background: #e3f2fd;
        }

        .character-item.selected {
            background: #bbdefb;
            border-color: #2196f3;
        }

        .character-properties {
            display: none;
        }

        .character-properties.active {
            display: block;
        }

        .property-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
        }

        .property-row label {
            color: #555;
            font-weight: 500;
        }

        .property-row input,
        .property-row select {
            padding: 5px 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background: white;
            color: #333;
        }

        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #45a049;
        }

        #no-selection {
            color: #666;
            font-style: italic;
        }

        .color-picker {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }

        .export-buttons button {
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
            font-size: 14px;
        }

        .export-buttons button:hover {
            background: #45a049;
        }

        .instructions {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #2e7d32;
        }

        .instructions h3 {
            margin-top: 0;
            color: #2e7d32;
        }

        .instructions ul {
            margin-bottom: 0;
        }
    </style>
</head>

<body>
    <div class="demo-container">
        <h1>Interactive Size Diff Demo</h1>

        <div class="instructions">
            <h3>How to use:</h3>
            <ul>
                <li><strong>Click</strong> on a character to select and edit its properties</li>
                <li><strong>Drag</strong> characters to reorder them</li>
                <li><strong>Change colors</strong> using the color picker in the right panel</li>
                <li><strong>Export</strong> your creation as an image or shareable URL</li>
            </ul>
        </div>

        <div class="canvas-container">
            <canvas id="interactive-canvas"></canvas>
        </div>

        <div class="controls">
            <div class="control-panel">
                <h3>Characters</h3>
                <div class="character-list" id="character-list">
                    <!-- Character items will be populated here -->
                </div>

                <h3>Render Options</h3>
                <div class="property-row">
                    <label>Measure to ears:</label>
                    <input type="checkbox" id="measure-ears" checked>
                </div>
                <div class="property-row">
                    <label>Species scaling:</label>
                    <input type="checkbox" id="species-scaling">
                </div>
                <div class="property-row">
                    <label>Image size:</label>
                    <select id="image-size">
                        <option value="400">400px</option>
                        <option value="600">600px</option>
                        <option value="800" selected>800px</option>
                        <option value="1024">1024px</option>
                    </select>
                </div>
            </div>

            <div class="control-panel">
                <h3>Character Properties</h3>
                <div id="no-selection">Select a character to edit its properties</div>
                <div class="character-properties" id="character-properties">
                    <div class="property-row">
                        <label>Name:</label>
                        <input type="text" id="char-name" placeholder="Character name">
                    </div>
                    <div class="property-row">
                        <label>Height:</label>
                        <input type="number" id="char-height" step="0.1" placeholder="Height in inches">
                    </div>
                    <div class="property-row">
                        <label>Color tint:</label>
                        <input type="color" id="char-color" class="color-picker" value="#ffffff">
                    </div>
                    <div class="property-row">
                        <button id="remove-character">Remove Character</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="export-buttons">
            <button id="export-png">Export as PNG</button>
            <button id="export-url">Copy Shareable URL</button>
            <button id="add-sample-chars">Add Sample Characters</button>
        </div>

        <div>
            <p><a href="{{ url_for('index') }}">&larr; Back to original calculator</a></p>
        </div>
    </div>

    <!-- Include our renderer scripts -->
    <script src="{{ url_for('static', filename='js/universal-renderer.js') }}"></script>
    <script src="{{ url_for('static', filename='js/interactive-renderer.js') }}"></script>

    <script>
        class SizeDiffDemo {
            constructor() {
                this.renderer = null;
                this.selectedCharacterIndex = -1;
                this.sampleCharacters = [
                    {
                        name: "Sinopa",
                        species: "red_fox",
                        gender: "female",
                        height: 66,
                        feral_height: 66,
                        image: "sinopa.png",
                        ears_offset: 1.5,
                        color: null
                    },
                    {
                        name: "Wolf",
                        species: "wolf",
                        gender: "male",
                        height: 72,
                        feral_height: 72,
                        image: "m_wolf.png",
                        ears_offset: 3,
                        color: null
                    }
                ];

                this.init();
            }

            async init() {
                // Initialize renderer
                const canvas = document.getElementById('interactive-canvas');
                this.renderer = new InteractiveRenderer({
                    size: 800,
                    measureToEars: true,
                    useSpeciesScaling: false,
                    onCharacterSelect: this.onCharacterSelect.bind(this),
                    onCharactersReorder: this.onCharactersReorder.bind(this),
                    onCharacterUpdate: this.onCharacterUpdate.bind(this)
                });

                await this.renderer.initialize(canvas);

                // Setup event listeners
                this.setupEventListeners();

                // Load sample characters
                await this.renderer.updateCharacters(this.sampleCharacters);
                this.updateCharacterList();
            }

            setupEventListeners() {
                // Render option changes
                document.getElementById('measure-ears').addEventListener('change', (e) => {
                    this.renderer.options.measureToEars = e.target.checked;
                    this.renderer.render(this.renderer.characters);
                });

                document.getElementById('species-scaling').addEventListener('change', (e) => {
                    this.renderer.options.useSpeciesScaling = e.target.checked;
                    this.renderer.render(this.renderer.characters);
                });

                document.getElementById('image-size').addEventListener('change', (e) => {
                    this.renderer.options.size = parseInt(e.target.value);
                    this.renderer.render(this.renderer.characters);
                });

                // Character property changes
                document.getElementById('char-name').addEventListener('input', (e) => {
                    if (this.selectedCharacterIndex >= 0) {
                        this.renderer.updateCharacterProperty(this.selectedCharacterIndex, 'name', e.target.value);
                        this.updateCharacterList();
                    }
                });

                document.getElementById('char-height').addEventListener('input', (e) => {
                    if (this.selectedCharacterIndex >= 0) {
                        const height = parseFloat(e.target.value);
                        this.renderer.updateCharacterProperty(this.selectedCharacterIndex, 'height', height);
                        this.renderer.updateCharacterProperty(this.selectedCharacterIndex, 'feral_height', height);
                        this.updateCharacterList();
                    }
                });

                document.getElementById('char-color').addEventListener('input', (e) => {
                    if (this.selectedCharacterIndex >= 0) {
                        const color = e.target.value.substring(1); // Remove # from hex color
                        this.renderer.updateCharacterProperty(this.selectedCharacterIndex, 'color', color);
                    }
                });

                document.getElementById('remove-character').addEventListener('click', () => {
                    if (this.selectedCharacterIndex >= 0) {
                        this.renderer.removeCharacter(this.selectedCharacterIndex);
                        this.selectedCharacterIndex = -1;
                        this.updateCharacterList();
                        this.updateCharacterProperties();
                    }
                });

                // Export buttons
                document.getElementById('export-png').addEventListener('click', () => {
                    this.exportAsPNG();
                });

                document.getElementById('export-url').addEventListener('click', () => {
                    this.exportAsURL();
                });

                document.getElementById('add-sample-chars').addEventListener('click', () => {
                    this.addSampleCharacters();
                });
            }

            onCharacterSelect(character, index) {
                this.selectedCharacterIndex = index;
                this.updateCharacterList();
                this.updateCharacterProperties();
            }

            onCharactersReorder(characters) {
                this.updateCharacterList();
                // Adjust selected index if needed
                if (this.selectedCharacterIndex >= characters.length) {
                    this.selectedCharacterIndex = -1;
                    this.updateCharacterProperties();
                }
            }

            onCharacterUpdate(character, index) {
                // Character was updated, refresh the list
                this.updateCharacterList();
            }

            updateCharacterList() {
                const listElement = document.getElementById('character-list');
                listElement.innerHTML = '';

                this.renderer.characters.forEach((char, index) => {
                    const item = document.createElement('div');
                    item.className = 'character-item';
                    if (index === this.selectedCharacterIndex) {
                        item.classList.add('selected');
                    }

                    item.innerHTML = `
                        <strong>${char.name}</strong><br>
                        <small>${char.species.replace('_', ' ')} • ${char.height}"</small>
                    `;

                    item.addEventListener('click', () => {
                        this.onCharacterSelect(char, index);
                    });

                    listElement.appendChild(item);
                });
            }

            updateCharacterProperties() {
                const noSelection = document.getElementById('no-selection');
                const properties = document.getElementById('character-properties');

                if (this.selectedCharacterIndex >= 0) {
                    const char = this.renderer.characters[this.selectedCharacterIndex];

                    noSelection.style.display = 'none';
                    properties.classList.add('active');

                    document.getElementById('char-name').value = char.name;
                    document.getElementById('char-height').value = char.height;
                    document.getElementById('char-color').value = char.color ? `#${char.color}` : '#ffffff';
                } else {
                    noSelection.style.display = 'block';
                    properties.classList.remove('active');
                }
            }

            async exportAsPNG() {
                try {
                    const blob = await this.renderer.exportAsBlob();
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'size-comparison.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);

                    URL.revokeObjectURL(url);
                } catch (error) {
                    console.error('Export failed:', error);
                    alert('Export failed. Please try again.');
                }
            }

            exportAsURL() {
                const params = this.renderer.exportAsURLParams();
                const url = `${window.location.origin}/?${params}`;

                navigator.clipboard.writeText(url).then(() => {
                    alert('Shareable URL copied to clipboard!');
                }).catch(() => {
                    prompt('Copy this URL to share:', url);
                });
            }

            async addSampleCharacters() {
                // Add a few more sample characters for testing
                const moreSamples = [
                    {
                        name: "Hunner",
                        species: "mouse",
                        gender: "female",
                        height: 48,
                        feral_height: 48,
                        image: "f_mouse_hunner.png",
                        ears_offset: 8,
                        color: null
                    },
                    {
                        name: "Giraffe",
                        species: "giraffe",
                        gender: "male",
                        height: 84,
                        feral_height: 84,
                        image: "m_giraffe.png",
                        ears_offset: 2,
                        color: null
                    }
                ];

                for (const char of moreSamples) {
                    await this.renderer.addCharacter(char);
                }
                this.updateCharacterList();
            }
        }

        // Initialize the demo when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new SizeDiffDemo();
        });
    </script>
</body>

</html>