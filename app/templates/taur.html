<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Taur Calculator</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/taur_app.css') }}">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
</head>

<body>
    <div class="taur-container">
        <div class="taur-left-column">
            <div class="taur-canvas-container">
                <canvas id="taur-canvas"></canvas>
            </div>
        </div>
        <div class="taur-right-column">
            <div class="taur-header">
                <h1>Taur Calculator</h1>
                <p>By Vixi and <a href="https://www.f-list.net/c/Volnar" style="color: #78d0ff;">Volnar</a>!</p>
            </div>




            <!-- REMOVE ME -->
            {% if calculation_result %}
            <div class="taur-results">
                <h2 style="color: #f80; margin-bottom: 15px;">Calculation Results</h2>
                <div class="results-box">
                    <table style="width:100%; border-collapse: collapse;">
                        <tbody>
                            {% for key, value in calculation_result.items() %}
                            <tr>
                                <td style="font-weight: bold; padding: 4px; border-bottom: 1px solid #222;">{{ key }}
                                </td>
                                <td style="padding: 4px; border-bottom: 1px solid #222;">
                                    {% if value is string %}
                                    {{ value.replace('\\u0027', "'") }}
                                    {% elif value is mapping %}
                                    { }
                                    {% else %}
                                    {{ value }}
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}

            <form method="POST" class="taur-form" id="taur-form">
                <div class="taur-form-group">
                    <label for="name">Name:</label>
                    <input type="text" id="name" name="name" placeholder="Character name" />
                </div>

                <div class="taur-form-group">
                    <label for="measurement_type">Measurement Type: <span class="info-icon"
                            title="Vitruvian: Default for mammals, the body height and upper limbs are scaled such that you can reach your own tail when bending over backwards. 
                            Limb: For lizards/dragons and others where body length may not be symmetrical. Will use species length directly">ℹ️</span></label>
                    <select id="measurement_type" name="measurement_type">
                        <option value="vitruvian">Vitruvian (for mammals)</option>
                        <option value="limb">Limb (for lizards/dragons and all else)</option>
                    </select>
                </div>

                <div class="taur-form-group">
                    <label for="species">Species:</label>
                    <select id="species" name="species">
                        {% for specie in species %}
                        <option value="{{ specie }}">{{ specie.replace('_', ' ').title() }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="taur-form-group">
                    <label for="anthro_height">Anthro Height (AH): <span class="info-icon"
                            title="Your anthro height before taurification, measured in inches">ℹ️</span></label>
                    <input type="number" step="0.1" id="anthro_height" name="anthro_height" placeholder="e.g., 76" />
                </div>

                <div class="taur-form-group">
                    <label for="species_height">Species Height (SH): <span class="info-icon"
                            title="Your species's feral height, measured in inches">ℹ️</span></label>
                    <input type="number" step="0.1" id="species_height" name="species_height" placeholder="e.g., 36" />
                </div>

                <div class="taur-form-group">
                    <label for="species_length">Species Length w/o Tail (SL): <span class="info-icon"
                            title="Your species's body length from nose to base of tail, measured in inches">ℹ️</span></label>
                    <input type="number" step="0.1" id="species_length" name="species_length" placeholder="e.g., 48" />
                </div>

                <div class="taur-form-group">
                    <label for="species_tail_length">Species Tail Length (ST): <span class="info-icon"
                            title="Your species's tail length, measured in inches">ℹ️</span></label>
                    <input type="number" step="0.1" id="species_tail_length" name="species_tail_length"
                        placeholder="e.g., 24" />
                </div>

                <div class="taur-form-group">
                    <label for="taur_full_height">Taur Full Height (TFH): <span class="info-icon"
                            title="Your desired final taur height (from pawpads to top of head not including horns, ears or antlers), measured in inches">ℹ️</span></label>
                    <input type="number" step="0.1" id="taur_full_height" name="taur_full_height"
                        placeholder="e.g., 108" />
                </div>

                <div class="taur-form-group">
                    <label for="species_weight">Species Weight (SW): <span class="info-icon"
                            title="Your species's weight, measured in pounds (NOT YOUR OC'S WEIGHT!)">ℹ️</span></label>
                    <input type="number" step="0.1" id="species_weight" name="species_weight" placeholder="e.g., 150" />
                </div>

                <div class="taur-form-group">
                    <label for="taur_length">Taur Length w/o Tail (TL) - Optional: <span class="info-icon"
                            title="The body length of the taur (from front to base of tail). Leave empty to auto-calculate">ℹ️</span></label>
                    <input type="number" step="0.1" id="taur_length" name="taur_length"
                        placeholder="Leave empty for auto" />
                </div>

                <button type="submit">Calculate</button>
            </form>
            <div class="back-link-container">
                <a href="/" class="back-link">&larr; Back to Main Calculator</a>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('taur-canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();

        function drawImage() {
            const maxW = window.innerWidth / 2;
            const maxH = window.innerHeight;
            const scale = Math.min(maxW / img.width, maxH / img.height, 1.0);

            canvas.width = img.width * scale;
            canvas.height = img.height * scale;
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        }

        function drawText(name, height, species) {
            const scale = canvas.width / img.width;
            ctx.fillStyle = '#fff';
            ctx.font = `bold ${24 * scale}px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText(name, canvas.width / 2, 50 * scale);
            ctx.fillText(height + '"', canvas.width / 2, 80 * scale);
            ctx.font = `${20 * scale}px Arial`;
            ctx.fillText(species.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()), canvas.width / 2, 110 * scale);
        }

        img.onload = drawImage;
        img.src = "{{ url_for('static', filename='images/taur/TaurCalculatorReference.png') }}";

        // Species data for auto-population
        const speciesData = {{ species_data | tojson | safe }};

        // Handle species selection to auto-populate fields
        document.getElementById('species').addEventListener('change', function () {
            const selectedSpecies = this.value;
            const data = speciesData[selectedSpecies];

            if (data) {
                document.getElementById('species_height').value = data.species_height || '';
                document.getElementById('species_length').value = data.species_length || '';
                document.getElementById('species_tail_length').value = data.species_tail_length || '';
                document.getElementById('species_weight').value = data.species_weight || '';
            }
        });

        // Trigger on page load if species is already selected (only if not loading from URL params)
        {% if not form_data %}
        document.getElementById('species').dispatchEvent(new Event('change'));
        {% endif %}

        document.getElementById('taur-form').addEventListener('submit', function (e) {
            e.preventDefault();
            const formData = new FormData(this);

            // Validate required fields
            const required = ['anthro_height', 'species_height', 'species_length', 'species_tail_length', 'taur_full_height', 'species_weight'];
            for (const field of required) {
                if (!formData.get(field)) {
                    alert(`Please fill in all required fields. Missing: ${field}`);
                    return;
                }
            }

            // Build URL with parameters
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                if (value) {
                    params.append(key, value);
                }
            }

            // Redirect to taur page with parameters
            window.location.href = `/taur?${params.toString()}`;
        });

        // Populate form from URL parameters if present
        {% if form_data %}
        const urlParams = new URLSearchParams(window.location.search);
        for (const [key, value] of urlParams.entries()) {
            const input = document.getElementById(key) || document.querySelector(`[name="${key}"]`);
            if (input) {
                input.value = value;
            }
        }
        // Trigger species change to populate fields
        document.getElementById('species').dispatchEvent(new Event('change'));
        {% endif %}
    </script>
</body>

</html>